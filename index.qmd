---
title: "Sri Lanka Dengue Atlas"
---

```{r}
#| warning: false
#| message: false
library(dplyr)
library(sf)
library(lubridate)
library(scales)
library(denguedatahub)
library(htmlwidgets)
library(crosstalk)
library(ceylon)
```

```{r}
srilanka_weekly_data <- srilanka_weekly_data %>%
  mutate(
    start.date = as.Date(start.date, format = "%m/%d/%Y"),
    end.date   = as.Date(end.date,   format = "%m/%d/%Y")
  )
```

```{r}
filter_by_date <- function(data, from_date, to_date) {
  data %>%
    filter(
      start.date <= to_date,
      end.date   >= from_date
    )
}

```

```{r}
aggregate_district_cases <- function(data) {
  data %>%
    group_by(district) %>%
    summarise(
      cases = sum(cases, na.rm = TRUE),
      .groups = "drop"
    )
}

```


```{r}
data(district)
sl_districts <-  district %>%
  st_transform(4326) 
```

```{r}
make_map_data <- function(from_date, to_date) {

  dengue_filtered <- srilanka_weekly_data %>%
    filter_by_date(from_date, to_date) %>%
    aggregate_district_cases()

 # sl_districts %>%
 #   left_join(dengue_filtered, by = "district") %>%
 #   mutate(cases = replace_na(cases, 0))
  
  dengue_filtered <- dengue_filtered %>%
  mutate(district = toupper(district))

  sl_districts <- sl_districts %>%
  mutate(DISTRICT = toupper(DISTRICT))
  
  sl_map_data <- sl_districts %>%
  left_join(dengue_filtered, by = c("DISTRICT" = "district")) #%>%
#  mutate(cases = replace_na(cases, 0))

}

```



```{r}
map_data <- make_map_data(
  from_date = as.Date("2019-01-01"),
  to_date   = as.Date("2019-12-31")
)

map_data

```

```{r}
library(ggplot2)

ggplot(map_data) +
  geom_sf(
    aes(fill = cases),
    color = "white",
    linewidth = 0.2
  ) +
#  scale_fill_brewer(
 #   palette = "YlOrRd",
 #   na.value = "grey90",
#    name = "Annual dengue cases"
#  ) +
  labs(
    title = "Annual Dengue Cases by District",
    subtitle = "Sri Lanka",
    caption = "Source: Dengue surveillance data"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid = element_blank(),
    axis.text  = element_blank(),
    axis.title = element_blank(),
    legend.position = "right"
  )

```